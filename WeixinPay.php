<?php
 class WeixinPay { protected $appid; protected $mch_id; protected $key; protected $openid; protected $out_trade_no; protected $body; protected $total_fee; protected $identity; protected $sub_mchid; protected $attach; function __construct($appid, $openid, $mch_id, $key, $out_trade_no, $body, $total_fee, $identity, $sub_mchid, $attach = '') { goto VqPjD; fbSG2: $this->body = $body; goto xzKCH; P3iWH: $this->openid = $openid; goto byWuD; J1tjR: $this->attach = $attach; goto R_yVn; xzKCH: $this->total_fee = $total_fee; goto pKdd0; pKdd0: $this->identity = $identity; goto HN6iB; sQj7D: $this->key = $key; goto Jjk3a; VqPjD: $this->appid = $appid; goto P3iWH; byWuD: $this->mch_id = $mch_id; goto sQj7D; HN6iB: $this->sub_mchid = $sub_mchid; goto J1tjR; Jjk3a: $this->out_trade_no = $out_trade_no; goto fbSG2; R_yVn: } public function pay() { $return = $this->weixinapp(); return $return; } private function unifiedorder() { goto jloNd; YgisU: $xmlData = $this->arrayToXml($parameters); goto VOXUz; BTU4s: if (!$this->attach) { goto GcVbz; } goto AM85r; qTh4o: if (!($this->identity == 1)) { goto RR2nB; } goto G9l0V; uYaif: if (!($this->identity == 2)) { goto e37cD; } goto N4QOx; Y1T37: GcVbz: goto X3Bwz; AP713: $parameters = array("\141\x70\x70\x69\144" => $this->appid, "\142\157\x64\171" => $this->body, "\x6d\143\x68\x5f\151\144" => $this->mch_id, "\x6e\157\x6e\143\145\137\x73\164\x72" => $this->createNoncestr(), "\156\x6f\164\151\x66\x79\137\x75\162\154" => $this->getNotifyUrl("\x2f\x61\x64\144\x6f\156\x73\x2f\x73\x75\x64\165\x38\137\160\141\147\145\57\x70\x61\x79\56\160\150\x70"), "\157\165\x74\137\x74\x72\141\144\x65\x5f\156\157" => $this->out_trade_no, "\x74\157\x74\141\154\x5f\146\x65\145" => $this->total_fee, "\x74\162\141\x64\x65\x5f\164\171\x70\x65" => "\x4a\123\101\120\111"); goto qTh4o; RN0MZ: e37cD: goto BTU4s; t3hnV: $parameters["\x73\x75\142\x5f\157\x70\145\156\151\x64"] = $this->openid; goto RN0MZ; G9l0V: $parameters["\157\160\x65\x6e\x69\x64"] = $this->openid; goto Id_VN; N4QOx: $parameters["\163\x75\142\x5f\141\160\160\151\x64"] = $this->appid; goto Gd5sx; X3Bwz: $parameters["\163\x69\147\156"] = $this->getSign($parameters); goto YgisU; jloNd: $url = "\150\164\164\x70\x73\72\x2f\x2f\141\x70\151\x2e\155\x63\x68\56\x77\145\151\x78\x69\x6e\x2e\x71\161\x2e\x63\157\x6d\57\x70\x61\171\x2f\x75\x6e\151\146\151\145\144\157\162\x64\x65\x72"; goto AP713; Id_VN: RR2nB: goto uYaif; AM85r: $parameters["\x61\x74\164\x61\143\x68"] = $this->attach; goto Y1T37; Gd5sx: $parameters["\163\x75\142\x5f\x6d\143\x68\137\151\x64"] = $this->mch_id; goto t3hnV; VOXUz: $return = $this->xmlToArray($this->postXmlCurl($xmlData, $url, 60)); goto jsJGO; jsJGO: return $return; goto nz32o; nz32o: } protected function getNotifyUrl($url) { goto ki8ow; v9kSS: $current_url = "\x68\x74\x74\160\163\72\x2f\57"; goto ntRlt; ntRlt: IH3Nf: goto qNFqf; qNFqf: $current_url .= $_SERVER["\110\124\x54\120\137\x48\117\123\124"] . strstr($_SERVER["\x52\105\121\125\x45\x53\124\x5f\x55\122\x49"], "\57\x61\160\160\x2f\x69\x6e\144\x65\x78", true) . $url; goto bSheG; ki8ow: $current_url = "\150\x74\164\160\72\57\57"; goto FHKWp; bSheG: return $current_url; goto muxTd; FHKWp: if (!(isset($_SERVER["\110\124\124\x50\123"]) && $_SERVER["\110\x54\124\x50\x53"] == "\157\156")) { goto IH3Nf; } goto v9kSS; muxTd: } private static function postXmlCurl($xml, $url, $second = 30) { goto nxW7_; ZKnNZ: throw new WxPayException("\x63\x75\162\154\xe5\207\272\351\224\x99\xef\xbc\214\351\224\231\350\257\xaf\xe7\240\x81\x3a{$error}"); goto LKCSU; nxW7_: $ch = curl_init(); goto md67_; wu5By: $error = curl_errno($ch); goto Ku49a; vDmtf: curl_close($ch); goto SBBtU; LKCSU: goto of7V8; goto xuiQA; md67_: curl_setopt($ch, CURLOPT_TIMEOUT, $second); goto tCM1Y; Sqxmq: curl_setopt($ch, CURLOPT_RETURNTRANSFER, TRUE); goto HK_cQ; WEapP: curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, FALSE); goto P0Drh; HK_cQ: curl_setopt($ch, CURLOPT_POST, TRUE); goto sv3PY; P0Drh: curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, FALSE); goto u6W8O; sv3PY: curl_setopt($ch, CURLOPT_POSTFIELDS, $xml); goto y9qNk; Y0CTf: if ($data) { goto iQKxS; } goto wu5By; rceXy: curl_setopt($ch, CURLOPT_TIMEOUT, 40); goto nm6Bw; tCM1Y: curl_setopt($ch, CURLOPT_URL, $url); goto WEapP; KFrmC: $data = curl_exec($ch); goto Y0CTf; nm6Bw: set_time_limit(0); goto KFrmC; NOtq0: of7V8: goto DhpyZ; xuiQA: iQKxS: goto vDmtf; SBBtU: return $data; goto NOtq0; u6W8O: curl_setopt($ch, CURLOPT_HEADER, FALSE); goto Sqxmq; Ku49a: curl_close($ch); goto ZKnNZ; y9qNk: curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, 20); goto rceXy; DhpyZ: } protected function arrayToXml($arr) { goto oq7wg; jTQCJ: $xml .= "\x3c\57\x72\157\x6f\164\76"; goto QKKhY; ivDvh: eU2R0: goto jTQCJ; QKKhY: return $xml; goto eg1if; oq7wg: $xml = "\x3c\162\157\157\x74\76"; goto Xrta2; Xrta2: foreach ($arr as $key => $val) { goto GHUe7; n3AAY: HqQst: goto Cktt9; Cktt9: $xml .= "\x3c" . $key . "\x3e" . arrayToXml($val) . "\x3c\57" . $key . "\76"; goto ZSo3w; j9CZX: $xml .= "\x3c" . $key . "\x3e" . $val . "\x3c\x2f" . $key . "\x3e"; goto V3vs_; BCmna: h0ZXg: goto aSE6C; ZSo3w: PZSNU: goto BCmna; GHUe7: if (is_array($val)) { goto HqQst; } goto j9CZX; V3vs_: goto PZSNU; goto n3AAY; aSE6C: } goto ivDvh; eg1if: } protected function xmlToArray($xml) { goto xutpf; ltmxy: return $val; goto FZ5Qo; xutpf: libxml_disable_entity_loader(true); goto ZaRM3; ZaRM3: $xmlstring = simplexml_load_string($xml, "\123\151\155\160\154\x65\x58\115\114\x45\x6c\x65\155\x65\156\x74", LIBXML_NOCDATA); goto lo3ao; lo3ao: $val = json_decode(json_encode($xmlstring), true); goto ltmxy; FZ5Qo: } private function weixinapp() { goto QEI0Z; NCKil: wi2vq: goto grXyj; gXmf_: $parameters = array("\x61\x70\160\x49\144" => $this->appid, "\x74\151\155\145\123\x74\x61\x6d\160" => '' . time() . '', "\x6e\157\156\143\145\123\164\x72" => $this->createNoncestr(), "\160\x61\x63\153\141\x67\145" => "\160\162\145\160\x61\171\x5f\x69\x64\75" . $unifiedorder["\160\162\145\x70\x61\171\137\x69\144"], "\x73\x69\147\x6e\124\x79\x70\145" => "\115\x44\65"); goto FjVze; ZyIUH: if ($unifiedorder["\x72\145\x74\165\162\156\x5f\143\157\144\x65"] == "\x46\x41\111\114") { goto wi2vq; } goto gXmf_; PYOa4: goto xUyQL; goto NCKil; XSOX3: $parameters["\x72\145\x74\165\162\156\137\x6d\x73\147"] = $unifiedorder["\x72\x65\x74\165\x72\x6e\x5f\x6d\x73\x67"]; goto OKBe0; FD1j_: return $parameters; goto YwdKg; QEI0Z: $unifiedorder = $this->unifiedorder(); goto ZyIUH; GXkWb: $parameters["\x72\145\164\165\x72\x6e\x5f\155\x73\x67"] = $unifiedorder["\x72\145\x74\165\162\156\x5f\x6d\163\147"]; goto FWxw0; Ea2z0: $parameters["\145\162\162\x73"] = 1; goto XSOX3; FWxw0: $parameters["\145\x72\x72\163"] = 0; goto PYOa4; FjVze: $parameters["\x70\141\171\123\x69\147\x6e"] = $this->getSign($parameters); goto GXkWb; grXyj: $parameters = array(); goto Ea2z0; OKBe0: xUyQL: goto FD1j_; YwdKg: } protected function createNoncestr($length = 32) { goto OmJ5w; WE1fm: if (!($i < $length)) { goto lEu1k; } goto IVcRB; XQmi2: goto zxeag; goto Co_WP; uVBqK: $i++; goto XQmi2; vConj: $i = 0; goto bS5pp; IVcRB: $str .= substr($chars, mt_rand(0, strlen($chars) - 1), 1); goto KC4j3; Co_WP: lEu1k: goto UkhWa; UkhWa: return $str; goto CnBKI; oqH9T: $str = ''; goto vConj; bS5pp: zxeag: goto WE1fm; KC4j3: GiQt4: goto uVBqK; OmJ5w: $chars = "\141\x62\143\x64\145\146\147\x68\151\x6a\x6b\154\x6d\x6e\x6f\x70\x71\162\163\x74\165\x76\167\x78\x79\x7a\x30\61\62\63\64\65\66\67\70\x39"; goto oqH9T; CnBKI: } protected function getSign($Obj) { goto MmMVU; T2oby: $String = md5($String); goto uIRrK; Lj14X: ksort($Parameters); goto TweNa; uIRrK: $result_ = strtoupper($String); goto brpcP; R2eHu: $String = $String . "\46\x6b\145\171\75" . $this->key; goto T2oby; smQb8: w3M8r: goto Lj14X; TweNa: $String = $this->formatBizQueryParaMap($Parameters, false); goto R2eHu; MmMVU: foreach ($Obj as $k => $v) { $Parameters[$k] = $v; zLJSV: } goto smQb8; brpcP: return $result_; goto OpPon; OpPon: } protected function formatBizQueryParaMap($paraMap, $urlencode) { goto kT0C3; BfMqW: $reqPar = substr($buff, 0, strlen($buff) - 1); goto q9zQ_; ctVjf: if (!(strlen($buff) > 0)) { goto vq4Zl; } goto BfMqW; L1NEj: return $reqPar; goto yr8T_; ZtUjl: ksort($paraMap); goto iYRG3; iYRG3: foreach ($paraMap as $k => $v) { goto lFd65; Bogr7: $v = urlencode($v); goto fOvDJ; lFd65: if (!$urlencode) { goto vhj5r; } goto Bogr7; PltMb: hSE3u: goto jmVr7; cNGSQ: $buff .= $k . "\75" . $v . "\46"; goto PltMb; fOvDJ: vhj5r: goto cNGSQ; jmVr7: } goto avoIP; q9zQ_: vq4Zl: goto L1NEj; avoIP: wZLp0: goto COFP5; COFP5: $reqPar; goto ctVjf; kT0C3: $buff = ''; goto ZtUjl; yr8T_: } }